<?xml version='1.0' encoding='UTF-8'?>
<project>
  <actions/>
  <description>Parameters can be configured through ENV vars.&#xd;
&#xd;
Restart all fleet units if $ALL is checked off.&#xd;
Otherwise, using a local cache of $FLEET_REPO, attempts to figure out what fleet units in $FLEET_UNIT_ROOT have been changed and restart them.</description>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>FLEET_REPO</name>
          <description>fleetctl unit repository - use a full SSH git URL!</description>
          <defaultValue>$FLEET_REPO</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>FLEET_UNIT_ROOT</name>
          <description>Dir in $FLEET_REPO that contains the unit files.</description>
          <defaultValue>$FLEET_UNIT_ROOT</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>FLEET_REV</name>
          <description>Revision of $FLEET_REPO to check out</description>
          <defaultValue>$FLEET_REV</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>RUNNING_USER</name>
          <description>User running fleetctl units in the control tier (e.g.: core)</description>
          <defaultValue>$RUNNING_USER</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>RUNNING_HOST</name>
          <description>Host machine that this instance of Jenkins is running on. Typically set via ENV var using the AWS metadata service.</description>
          <defaultValue>$RUNNING_HOST</defaultValue>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <canRoam>true</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>false</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>${SETUPKEYS}

# clone &amp;&amp; cache the fleetunits, checkout rev
(git clone ${FLEET_REPO} fleetunits) || (cd fleetunits &amp;&amp; git fetch &amp;&amp; cd -)
if [ &quot;${FLEET_REV}&quot; = &quot;&quot; ] || [ -z $FLEET_REV ] || [ $FLEET_REV = &apos;$FLEET_REV&apos; ]; then
    FLEET_REV=&quot;master&quot;
fi
git checkout ${FLEET_REV}

# service list
if $ALL; then
    CHANGED_UNITS=&quot;$(cd fleetunits &amp;&amp; find ${FLEET_UNIT_ROOT} -type f -exec ls \{\} \;)&quot;
else
    CHANGED_UNITS=&quot;$(cd fleetunits &amp;&amp; git diff origin/master --name-only)&quot;
fi
cd fleetunits &amp;&amp; git pull &amp;&amp; cd -

# filter for service files
# weird syntax is so that if the filtered list is empty, the build does not fail
CHANGED_UNITS=`echo $(echo &quot;$CHANGED_UNITS&quot; | grep -e &apos;service$&apos;)`
# no units to restart, exit
if [ &quot;${CHANGED_UNITS}&quot; = &quot;&quot; ]; then
    exit 0
fi

# remote dir
REMOTE_DIR=&quot;/home/${RUNNING_USER}/fleetunits&quot;

# ensure that the remote fleet units repo is setup
${SSHCMD} &quot;(git clone ${FLEET_REPO} ${REMOTE_DIR}) || (cd ${REMOTE_DIR} &amp;&amp; git pull)&quot;

for SERVICE_FILE in ${CHANGED_UNITS}; do
    SERVICE=$(echo ${SERVICE_FILE#$FLEET_UNIT_ROOT/}|cut -d&apos;.&apos; -f1)
    ${SSHCMD} &quot;fleetctl destroy ${SERVICE}&quot;
    ${SSHCMD} &quot;fleetctl submit ${REMOTE_DIR}/${SERVICE_FILE}&quot;
    ${SSHCMD} &quot;fleetctl start ${SERVICE}&quot;
done</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers/>
  <buildWrappers/>
</project>